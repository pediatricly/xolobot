{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Zoey the Xolo</title>
    <link rel="stylesheet" href="{% static 'chatbot/style.css' %}">
   <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
<a href="https://pediatricly.com" class="back-link" aria-label="Back to pediatricly home">
    â† Back to pediatricly home
</a>
<div class="container">
    <div class="header">
        <img src="{% static 'chatbot/zoey.jpg' %}" alt="Zoey">
        <h1>Zoey, Strategic Visionary and Oracle</h1>
          <p class="subtitle">
            Our Xolo runs the house and may answer your questions about life on her ranch,
            snack supply chains, and minion management.
         </p>
    </div>

    <div id="chat" class="chat"></div>

    <form id="chat-form">
        {% csrf_token %}
        <input type="text" id="message" placeholder="What is it you seek from Zoey?" autocomplete="off" />
        <button type="submit">Send</button>
    </form>
</div>

<script>
const form = document.getElementById("chat-form");
const input = document.getElementById("message");
const chat = document.getElementById("chat");
const button = form.querySelector("button");

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function addMessage(text, cls) {
    const div = document.createElement("div");
    div.className = "message " + cls;

    if (cls === "bot") {
        div.innerHTML = marked.parse(text);  // ğŸ‘ˆ Markdown here
    } else {
        div.textContent = text;              // user stays plain text
    }

    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

form.onsubmit = async (e) => {
    e.preventDefault();
    const text = input.value.trim();
    if (!text) return;

    addMessage(text, "user");
    input.value = "";
    button.disabled = true;

    // ğŸ‘‡ Placeholder while waiting
    const thoughts = [
      "Zoey is considering your requestâ€¦ ğŸ•",
      "Zoey is judging youâ€¦ğŸ•",
      "Zoey is consulting the budgetâ€¦ğŸ•",
      "Zoey is sunbathing. Please be patient.ğŸ•",
    ];
    
    const thinking = document.createElement("div");
    thinking.className = "message bot thinking";
    thinking.textContent = thoughts[Math.floor(Math.random() * thoughts.length)];
    chat.appendChild(thinking);
    chat.scrollTop = chat.scrollHeight;

    try {
        const res = await fetch("/ask/", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": getCookie("csrftoken"),
            },
            body: new URLSearchParams({ message: text })
        });

        const data = await res.json();
        chat.removeChild(thinking);
        addMessage(data.reply, "bot");
    } catch (err) {
        chat.removeChild(thinking);
        addMessage("Zoey is displeased. Try again.", "bot");
    }

    button.disabled = false;
};
</script>
</body>
</html>
